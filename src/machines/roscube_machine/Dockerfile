FROM qutms_driverless_base:18.04
# qutms_driverless_base generated by qutms_driverless/docker/Makefile

ARG USERNAME
ARG HOST_UID
# dialout group is used for compatability with mac
ARG HOST_GROUP=dialout

WORKDIR /tmp

# sensors
COPY ./src/hardware/sensors/conda_requirements ./conda_requirements
RUN source /home/${USERNAME}/mambaforge/bin/activate; \
    conda activate driverless_env &&\
    mamba install -y --file ./conda_requirements

# rosboard
COPY ./src/common/rosboard/conda_requirements ./conda_requirements
RUN source /home/${USERNAME}/mambaforge/bin/activate; \
    conda activate driverless_env &&\
    mamba install -y --file ./conda_requirements

# controllers
RUN apt-get update && apt-get install -y libgl1-mesa-glx
COPY ./src/navigation/controllers/conda_requirements ./conda_requirements
RUN source /home/${USERNAME}/mambaforge/bin/activate; \
    conda activate driverless_env &&\
    mamba install -y --file ./conda_requirements

# cleanup
RUN rm -f ./conda_requirements

WORKDIR /home/$USERNAME/driverless_ws
USER ${USERNAME}

# run a build
COPY --chown=${USERNAME}:${HOST_GROUP} ./src/ ./src
RUN source /home/${USERNAME}/mambaforge/bin/activate; \
    conda activate driverless_env &&\
    colcon build --symlink-install --packages-up-to \
        roscube_machine \
        sensors \
        rosboard \
        controllers \
    && rm -rf ./src
