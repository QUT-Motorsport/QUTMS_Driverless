FROM qutms_driverless_base:ubuntu-22.04
# qutms_driverless_base generated by qutms_driverless/docker/Makefile

ARG USERNAME
ARG HOST_UID
# dialout group is used for compatability with mac
ARG HOST_GROUP=dialout

WORKDIR /tmp

# installs for controllers?
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libgl1-mesa-glx \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

COPY ./src/machines/roscube_machine/roscube_requirements.txt ./requirements
RUN source /home/${USERNAME}/mambaforge/bin/activate; \
    conda activate driverless_env &&\
    mamba install -y --file ./requirements

# cleanup
RUN rm -f ./requirements

WORKDIR /home/$USERNAME/driverless_ws
USER ${USERNAME}

# copy in source
COPY --chown=${USERNAME}:${HOST_GROUP} ./src/ ./src

# run a ros build
RUN source /home/${USERNAME}/mambaforge/bin/activate; \
    conda activate driverless_env &&\
    colcon build --symlink-install --packages-up-to \
        roscube_machine

# delete source
RUN rm -rf ./src

# tell ROS to use Cyclone DDS
# ENV RMW_IMPLEMENTATION="rmw_cyclonedds_cpp"
# ENV CYCLONEDDS_URI=file:///home/developer/driverless_ws/src/machines/roscube_machine/cyclonedds.xml
