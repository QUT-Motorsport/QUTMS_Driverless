FROM qutms_driverless_ros_source:pytorch
# qutms_driverless_ros_source generated by qutms_driverless/docker/Makefile

ARG USERNAME
ARG HOST_UID
# dialout group is used for compatability with mac
ARG HOST_GROUP=dialout

WORKDIR /tmp 

# pycuda (TRT) env vars
ENV PATH="/usr/local/cuda-10.2/bin${PATH:+:${PATH}}"
ENV LD_LIBRARY_PATH="/usr/local/cuda-10.2/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"

# vision_pipeline
COPY ./src/perception/vision_pipeline/trt_requirements.txt ./trt_requirements.txt
RUN pip3 install -r trt_requirements.txt
RUN rm -f ./trt_requirements.txt

WORKDIR /home/$USERNAME/driverless_ws
USER ${USERNAME}

# run a build
COPY --chown=${USERNAME}:${HOST_GROUP} ./src/ ./src
RUN source /opt/ros/galactic/install/setup.bash; \
    colcon build --symlink-install --packages-up-to \
        jetson_machine \
        vision_pipeline \
    && rm -rf ./src
