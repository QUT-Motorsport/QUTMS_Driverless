FROM qutms_driverless_base:l4t-tensorrt-r8.0.1
# qutms_driverless_base generated by qutms_driverless/docker/Makefile

ARG USERNAME
ARG HOST_UID
# dialout group is used for compatability with mac
ARG HOST_GROUP=dialout

WORKDIR /tmp

WORKDIR /home/$USERNAME/driverless_ws
USER ${USERNAME}

# HACK: Set PYTHONPATH to include base libraries from container (we want tensorrt from the base environment)
ENV PYTHONPATH=/usr/local/lib/python3.8/dist-packages

# vision pipeline
COPY ./src/perception/vision_pipeline/trt_requirements.txt ./trt_requirements.txt
RUN source /home/${USERNAME}/mambaforge/bin/activate; \
    conda activate driverless_env && \
    pip install -r ./trt_requirements.txt \
    && rm -f ./trt_requirements.txt

# run a build
COPY --chown=${USERNAME}:${HOST_GROUP} ./src/ ./src
RUN source /home/${USERNAME}/mambaforge/bin/activate; \
    conda activate driverless_env && \
    colcon build --symlink-install --packages-up-to \
        jetson_machine \
        vision_pipeline \
    && rm -rf ./src

# tell ROS to use Cyclone DDS
ENV RMW_IMPLEMENTATION="rmw_cyclonedds_cpp"
ENV CYCLONEDDS_URI=file:///home/developer/driverless_ws/src/machines/jetson_machine/cyclonedds.xml
