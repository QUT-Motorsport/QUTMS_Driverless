version: "3.9"

services:
  # Base image containing dependencies.
  panda_terminal:
    build:
      context: ../../
      dockerfile: ./QUTMS_Driverless/docker/Dockerfile
      args:
        ROS_DISTRO: humble
        USERNAME: developer
        UID: 1000
        GID: 1000
    # Interactive shell
    stdin_open: true
    tty: true
    # Networking and IPC for ROS 2
    network_mode: host
    ipc: host
    pid: host
    # Needed to display graphical applications
    privileged: true
    environment:
      # Allows graphical programs in the container.
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    volumes:
      # /dev/shm is mounted in so that two foxy containers can talk to each other when using net=host, see: https://answers.ros.org/question/370595/ros2-foxy-nodes-cant-communicate-through-docker-container-border/
      - /dev/shm:/dev/shm
      - /dev/sbg:/dev/sbg
      # Allows graphical programs in the container.
      - $HOME/.Xauthority:/home/developer/.Xauthority
      # Mount the workspace folders (some with read-write permissions)
      - ../src:/home/developer/driverless_ws/src
      - ../tools:/home/developer/driverless_ws/tools
      - ../../bags:/home/developer/driverless_ws/bags:rw
      - ../../build:/home/developer/driverless_ws/build:rw
      - ../../log:/home/developer/driverless_ws/log:rw
      - ../../install:/home/developer/driverless_ws/install:rw
      - ../../slam_toolbox:/home/developer/driverless_ws/slam_toolbox
      - ../../sbg_ros2_driver:/home/developer/driverless_ws/sbg_ros2_driver
    devices:
      - /dev/dri:/dev/dri
    command: /bin/bash

  # Launch bringup
  panda:
    extends: panda_terminal
    command: ros2 launch vehicle_bringup bootup.launch.py
