version: "2.3"


# ==============================================================================
#                                 Components
# ==============================================================================

x-build: &build
    build:
        context: ../
        dockerfile: ./docker/Dockerfile
        args:
            USERNAME: ${USERNAME?USERNAME env var not set! Use the Makefile}
            HOST_UID: ${HOST_UID?HOST_UID env var not set! Use the Makefile}

x-user: &user
    user: ${USERNAME}

x-volumes_local: &volumes_local
    volumes:
        - $HOME/.Xauthority:/home/${USERNAME}/.Xauthority
        - ../src:/home/${USERNAME}/driverless_ws/src
        - ../datasets:/home/${USERNAME}/datasets

x-devices: &devices
    devices:
       - /dev/dri:/dev/dri

x-environment: &environment
    environment:
        DISPLAY: $DISPLAY

x-network: &network
    network_mode: "host"
    privileged: true

x-interactive: &interactive
    stdin_open: true
    tty: true

x-visible: &visible
    tty: true


# ==============================================================================
#                                 Services
# ==============================================================================
services:
    core:
        image: ros:noetic-ros-base
        <<: *network
        <<: *visible
        command: roscore

    ros:
        <<: *build
        <<: *user
        <<: *volumes_local
        <<: *devices
        <<: *environment
        <<: *network
        <<: *interactive
        command: /bin/bash

    sim_bridge:
        <<: *build
        <<: *user
        <<: *volumes_local
        <<: *devices
        <<: *environment
        <<: *network
        <<: *interactive
        command: /bin/bash -c "source /home/${USERNAME}/Formula-Student-Driverless-Simulator/ros/devel/setup.bash;
                               roslaunch fsds_ros_bridge fsds_ros_bridge.launch host:=${SIM_HOST?SIM_HOST not set in .env file} manual_mode:=true"
    
    ros_1_bridge:
        <<: *build
        <<: *user
        <<: *volumes_local
        <<: *devices
        <<: *environment
        <<: *network
        <<: *interactive
        command: /bin/bash -c "source /home/${USERNAME}/Formula-Student-Driverless-Simulator/ros/install_isolated/setup.bash;
                               source /home/${USERNAME}/ros_2_messages_ws/install/local_setup.bash;
                               source /home/${USERNAME}/bridge_ws/install/local_setup.bash;
                               ros2 run ros1_bridge dynamic_bridge --bridge-all-topics"
