version: "2.3"


# ==============================================================================
#                                 Components
# ==============================================================================

x-user: &user
    user: ${USERNAME?USERNAME env var not set! Use the Makefile}

x-volumes_local: &volumes_local
    volumes:
        - $HOME/.Xauthority:/home/${USERNAME}/.Xauthority
        - ../src:/home/${USERNAME}/driverless_ws/src
        - ../datasets:/home/${USERNAME}/datasets
        # Below is fix so that two foxy containers can talk to each other when using net=host
        # see: https://answers.ros.org/question/370595/ros2-foxy-nodes-cant-communicate-through-docker-container-border/
        - /dev/shm:/dev/shm

x-devices: &devices
    devices:
       - /dev/dri:/dev/dri

x-env-file: &env-file
    env_file:
        - ../.env

x-network: &network
    network_mode: "host"
    privileged: true

x-interactive: &interactive
    stdin_open: true
    tty: true

x-visible: &visible
    tty: true


# ==============================================================================
#                       Services (Targets in the Makefile)
# ==============================================================================

services:
    perception:
        build:
            context: ../
            dockerfile: ./src/perception/Dockerfile
            args:
                USERNAME: ${USERNAME?USERNAME env var not set! Use the Makefile}
                HOST_UID: ${HOST_UID?HOST_UID env var not set! Use the Makefile}
        <<: *env-file
        <<: *user
        <<: *volumes_local
        <<: *devices
        <<: *network
        <<: *interactive
        command: bash
    
    navigation:
        build:
            context: ../
            dockerfile: ./src/navigation/Dockerfile
            args:
                USERNAME: ${USERNAME?USERNAME env var not set! Use the Makefile}
                HOST_UID: ${HOST_UID?HOST_UID env var not set! Use the Makefile}
        <<: *env-file
        <<: *user
        <<: *volumes_local
        <<: *devices
        <<: *network
        <<: *interactive
        command: bash

    unreal_sim:
        build:
            context: ../
            dockerfile: ./src/unreal_sim/Dockerfile
            args:
                USERNAME: ${USERNAME?USERNAME env var not set! Use the Makefile}
                HOST_UID: ${HOST_UID?HOST_UID env var not set! Use the Makefile}
        volumes:
            # see x-volumes_local above for explanation of this
            - /dev/shm:/dev/shm
        <<: *env-file
        <<: *user
        <<: *devices
        <<: *network
        <<: *interactive
        command: bash
